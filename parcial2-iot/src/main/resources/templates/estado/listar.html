<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <!-- Head base del proyecto (Bootstrap, meta, etc.) -->
    <th:block th:replace="~{components/bootstrap :: head-bootstrap}"></th:block>

    <!-- Estilos base y específicos de la vista -->
    <link rel="stylesheet" th:href="@{/css/base/glasslight.css}">
    <link rel="stylesheet" th:href="@{/css/estado/listar.css}">

    <title>Estado de dispositivos - IoT Admin</title>
</head>
<body>
<!-- Sidebar corporativo -->
<div th:replace="~{components/sidebar :: sidebar}"></div>

<!-- Contenido principal -->
<main class="app-content">
    <div class="container-fluid py-4">

        <!-- Encabezado de página -->
        <header class="page-header mb-3">
            <h1 class="page-title">
                Estado de dispositivos
            </h1>
            <p class="page-subtitle">
                Último valor conocido por dispositivo y variable, actualizado a partir de la telemetría recibida.
            </p>
        </header>
        <div class="mb-2 small text-muted">En vivo: <span id="sseEstadoInd">desconectado</span></div>

        <!-- Alertas opcionales -->
        <div th:if="${ok}" class="alert alert-success alert-dismissible fade show mt-2" role="alert">
            <span th:text="${ok}">Operación exitosa</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
        </div>
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show mt-2" role="alert">
            <span th:text="${error}">Ha ocurrido un error.</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
        </div>

        <!-- Filtro por dispositivo -->
        <section class="card shadow-soft mb-4 mt-3">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
                    <h2 class="section-title mb-0">
                        Filtrar por dispositivo
                    </h2>
                </div>

                <form method="get" class="row g-3 align-items-end">
                    <div class="col-12 col-md-4">
                        <label for="dispositivoId" class="form-label fw-semibold">
                            Dispositivo
                        </label>
                        <select id="dispositivoId" name="dispositivoId"
                                class="form-select"
                                onchange="this.form.submit()">
                            <option value="" th:selected="${seleccionadoId == null}">
                                Todos los dispositivos
                            </option>
                            <option th:each="d : ${dispositivos}"
                                    th:value="${d.id}"
                                    th:selected="${seleccionadoId != null and d.id == seleccionadoId}"
                                    th:text="${d.nombre + (d.idExterno != null ? ' (' + d.idExterno + ')' : '')}">
                            </option>
                        </select>
                    </div>

                    <div class="col-12 col-md-2">
                        <button class="btn btn-primary w-100" type="submit">
                            <i class="bi bi-search me-1"></i> Aplicar
                        </button>
                    </div>
                </form>
            </div>
        </section>

        <!-- Tabla de estados -->
        <section class="card shadow-soft">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
                    <h2 class="section-title mb-0">Últimos estados registrados</h2>
                </div>

           <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                        <tr>
                            <th>Dispositivo</th>
                            <th>Variable</th>
                            <th>Último valor</th>
                            <th>Fecha / hora</th>
                        </tr>
                        </thead>
                        <tbody>
                        <!-- Cuando hay datos -->
                        <tr th:each="e : ${estados}"
                            th:attr="data-did=${e.dispositivoId},data-vid=${e.variableId}">
                            <td class="estado-dispositivo"
                                th:text="${e.dispositivoNombre}">Dispositivo</td>

                            <td class="estado-variable">
                                <span th:text="${e.variableEtiqueta != null ? e.variableEtiqueta : e.variableNombre}">Variable</span>
                                <span th:if="${e.tieneRegla}" class="badge text-bg-warning ms-2">Regla</span>
                            </td>

                            <td class="estado-valor">
                                <span th:if="${e.ultimoNumero != null}"
                                      th:text="${e.ultimoNumero}"></span>
                                <span th:if="${e.ultimoBooleano != null}"
                                      th:text="${e.ultimoBooleano}"></span>
                                <span th:if="${e.ultimoTexto != null}"
                                      th:text="${e.ultimoTexto}"></span>
                                <pre class="estado-json mb-0"
                                     th:if="${e.ultimoJson != null}"
                                     th:text="${e.ultimoJson}"></pre>
                            </td>

                            <td class="estado-fecha"
                                th:text="${#temporals.format(e.ultimoTs, 'yyyy-MM-dd HH:mm:ss')}">
                                2025-01-01 12:00:00
                            </td>
                        </tr>

                        <!-- Sin datos -->
                        <tr th:if="${#lists.isEmpty(estados)}">
                            <td colspan="4" class="table-empty text-center text-muted py-4">
                                No hay datos de estado para el filtro seleccionado.
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

    </div>
 </main>

 <!-- Scripts base -->
 <th:block th:replace="~{components/bootstrap :: scripts-bootstrap}"></th:block>

 <!-- SSE Estado: actualiza filas en vivo -->
 <script th:inline="javascript">
   (function(){
     const selectedId = /*[[${seleccionadoId}]]*/ null;
     const url = selectedId ? ("/sse/estado?dispositivoId=" + selectedId) : "/sse/estado";
     try {
          const es = new EventSource(url);
          const indEl = document.getElementById('sseEstadoInd');
          const setIndicator = (ok) => { if (indEl) indEl.textContent = ok ? 'conectado' : 'desconectado'; };
          es.addEventListener('open', ()=>setIndicator(true));
          es.addEventListener('error', ()=>setIndicator(false));
       es.addEventListener('update', (ev) => {
         try {
           const d = JSON.parse(ev.data);
           let sel = `tr[data-vid='${d.variableId}']`;
           if (!selectedId && d.dispositivoId) sel += `[data-did='${d.dispositivoId}']`;
           const row = document.querySelector(sel);
           if (!row) return;
           const valCell = row.querySelector('.estado-valor');
           const dateCell = row.querySelector('.estado-fecha');
           if (!valCell || !dateCell) return;
           valCell.innerHTML = '';
           if (d.ultimoNumero != null) { valCell.textContent = d.ultimoNumero; }
           else if (d.ultimoBooleano != null) { valCell.textContent = d.ultimoBooleano; }
           else if (d.ultimoTexto != null) { valCell.textContent = d.ultimoTexto; }
           else if (d.ultimoJson != null) { const pre=document.createElement('pre'); pre.className='estado-json mb-0'; pre.textContent=d.ultimoJson; valCell.appendChild(pre); }
           const ts = new Date(d.ultimoTs);
           if (!isNaN(ts)) {
             const pad = n => (n<10?('0'+n):n);
             const fmt = ts.getFullYear()+"-"+pad(ts.getMonth()+1)+"-"+pad(ts.getDate())+" "+pad(ts.getHours())+":"+pad(ts.getMinutes())+":"+pad(ts.getSeconds());
             dateCell.textContent = fmt;
           }
           // resaltar actualización
           row.classList.add('flash-update');
           setTimeout(()=>row.classList.remove('flash-update'), 800);
         } catch(_e) { /* noop */ }
       });
     } catch(_e) { /* SSE no disponible */ }
   })();
 </script>
 <style>
   .flash-update { animation: flashBg 0.8s ease; }
   @keyframes flashBg { from { background: rgba(200,240,200,.8);} to { background: transparent; } }
 </style>
</body>
</html>
