<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <!-- Head base del proyecto -->
    <th:block th:replace="~{components/bootstrap :: head-bootstrap}"></th:block>

    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <title th:text="${titulo} ?: 'Telemetría'">Telemetría</title>

    <!-- Estilos específicos -->
    <link rel="stylesheet" th:href="@{/css/base/glasslight.css}">
    <link rel="stylesheet" th:href="@{/css/telemetria/telemetria.css}">
</head>
<body>
<!-- Sidebar corporativo -->
<div th:replace="~{components/sidebar :: sidebar}"></div>

<!-- Contenido principal -->
<main class="app-content">
    <div class="container-fluid py-4">

        <!-- Header -->
        <header class="page-header">
            <h1 class="page-title" th:text="${titulo} ?: 'Telemetría'">Telemetría</h1>
            <p class="page-subtitle">
                Consulta lecturas recientes por dispositivo y variable.
            </p>
        </header>
        <div class="small text-muted">En vivo: <span id="sseTeleInd">desconectado</span></div>

        <!-- Filtros -->
        <section class="card shadow-soft mb-4">
            <div class="card-body">
                <form method="get" novalidate th:action="@{/telemetria}">
                    <div class="row g-3 align-items-end">

                        <!-- Dispositivo -->
                        <div class="col-12 col-md-4">
                            <label class="form-label fw-semibold" for="disp">Dispositivo</label>
                            <select class="form-select" id="disp" name="dispositivoId" onchange="this.form.submit()">
                                <option value="">—</option>
                                <option th:each="d : ${dispositivos}"
                                        th:selected="${d.id == dispositivoId}"
                                        th:text="${d.nombre + ' (' + d.idExterno + ')'}"
                                        th:value="${d.id}">
                                    Device
                                </option>
                            </select>
                        </div>

                        <!-- Variable -->
                        <div class="col-12 col-md-4">
                            <label class="form-label fw-semibold" for="var">Variable</label>
                            <select class="form-select" id="var" name="variableId">
                                <option value="">—</option>
                                <option th:each="v : ${variables}"
                                        th:selected="${v.id == variableId}"
                                        th:text="${v.nombre}"
                                        th:value="${v.id}">
                                    Var
                                </option>
                            </select>
                        </div>

                        <!-- Cantidad -->
                        <div class="col-12 col-md-3">
                            <label class="form-label fw-semibold" for="limit">Cantidad</label>
                            <input class="form-control" id="limit" max="500" min="1" name="limit" th:value="${limit}"
                                   type="number"/>
                            <div class="form-text">Máx. 500 registros</div>
                        </div>

                        <!-- Botón -->
                        <div class="col-12 col-md-1 d-grid">
                            <button class="btn btn-primary" type="submit">Ver</button>
                        </div>
                        <div class="col-12 col-md-2 d-grid" th:if="${dispositivoId != null and variableId != null}">
                            <a class="btn btn-outline-secondary"
                               th:href="@{|/telemetria/export?dispositivoId=${dispositivoId}&variableId=${variableId}|}">
                                <i class="bi bi-download me-1"></i> Exportar CSV
                            </a>
                        </div>

                    </div>
                    <p class="text-muted mt-2 mb-0">
                        Primero elige un dispositivo; la lista de variables se llena con las de su plantilla.
                    </p>
                </form>
            </div>
        </section>

        <!-- Resultados -->
        <section aria-live="polite" class="card shadow-soft" th:if="${#lists.size(filas) > 0}">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
                    <h2 class="section-title mb-0">Últimas lecturas</h2>
                    <div class="small text-muted">
    <span th:if="${dispositivoNombre != null}">
      Disp: <strong th:text="${dispositivoNombre}">—</strong>
    </span>
                        <span class="mx-2" th:if="${dispositivoNombre != null && variableNombre != null}">•</span>
                        <span th:if="${variableNombre != null}">
      Var: <strong th:text="${variableNombre}">—</strong>
    </span>
                        <span class="mx-2">•</span>
                        <span>Registros: <strong th:text="${#lists.size(filas)}">0</strong></span>
                    </div>
                </div>


                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                        <tr>
                            <th>Timestamp</th>
                            <th>Valor</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="f : ${filas}">
                            <td class="text-nowrap" th:text="${#temporals.format(f.ts, 'yyyy-MM-dd HH:mm:ss')}">—</td>
                            <td>
                                <span th:if="${f.valorNumero != null}" th:text="${f.valorNumero}"></span>
                                <span th:if="${f.valorBooleano != null}" th:text="${f.valorBooleano}"></span>
                                <span th:if="${f.valorTexto != null}" th:text="${f.valorTexto}"></span>
                                <pre class="json-pre" th:if="${f.valorJson != null}" th:text="${f.valorJson}"></pre>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>

            </div>
        </section>

        <!-- Vacío -->
        <section class="card shadow-soft" th:if="${#lists.size(filas) == 0}">
            <div class="card-body">
                <p class="text-muted mb-0">No hay lecturas para ese filtro.</p>
            </div>
        </section>

    </div>
</main>

<!-- Scripts base -->
<th:block th:replace="~{components/bootstrap :: scripts-bootstrap}"></th:block>

<!-- SSE Telemetría: añade nuevas lecturas en vivo -->
<script th:inline="javascript">
  (function(){
    const dispositivoId = /*[[${dispositivoId}]]*/ null;
    const variableId = /*[[${variableId}]]*/ null;
    const limit = /*[[${limit}]]*/ 50;
    if (!dispositivoId || !variableId) return;
    try {
      const url = `/sse/telemetria?dispositivoId=${dispositivoId}&variableId=${variableId}`;
      const es = new EventSource(url);
      const indEl = document.getElementById('sseTeleInd');
      const setIndicator = (ok) => { if (indEl) indEl.textContent = ok ? 'conectado' : 'desconectado'; };
      es.addEventListener('open', ()=>setIndicator(true));
      es.addEventListener('error', ()=>setIndicator(false));
      es.addEventListener('update', (ev) => {
        try {
          const d = JSON.parse(ev.data);
          const tbody = document.querySelector('table tbody');
          if (!tbody) return;
          const tr = document.createElement('tr');
          const tdTs = document.createElement('td');
          const tdVal = document.createElement('td');
          tdTs.className = 'text-nowrap';
          const ts = new Date(d.ts);
          if (!isNaN(ts)) {
            const pad = n => (n<10?('0'+n):n);
            tdTs.textContent = ts.getFullYear()+"-"+pad(ts.getMonth()+1)+"-"+pad(ts.getDate())+" "+pad(ts.getHours())+":"+pad(ts.getMinutes())+":"+pad(ts.getSeconds());
          } else { tdTs.textContent = d.ts; }
          if (d.numero != null) tdVal.textContent = d.numero;
          else if (d.booleano != null) tdVal.textContent = d.booleano;
          else if (d.texto != null) tdVal.textContent = d.texto;
          else if (d.json != null) { const pre=document.createElement('pre'); pre.className='json-pre'; pre.textContent=d.json; tdVal.appendChild(pre); }
          tr.appendChild(tdTs); tr.appendChild(tdVal);
          // Prepend
          if (tbody.firstChild) tbody.insertBefore(tr, tbody.firstChild); else tbody.appendChild(tr);
          // Trim
          while (tbody.children.length > limit) tbody.removeChild(tbody.lastChild);
          tr.classList.add('flash-update');
          setTimeout(()=>tr.classList.remove('flash-update'), 800);
        } catch(_e) { /* noop */ }
      });
    } catch(_e) { /* SSE no disponible */ }
  })();
</script>
<style>
  .flash-update { animation: flashBg 0.8s ease; }
  @keyframes flashBg { from { background: rgba(200,220,255,.8);} to { background: transparent; } }
</style>
</body>
</html>
