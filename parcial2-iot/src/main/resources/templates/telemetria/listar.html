<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <th:block th:replace="~{components/bootstrap :: head-bootstrap}"></th:block>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" th:href="@{/css/telemetria/telemetria.css}">
</head>
<body>
<div th:replace="~{components/sidebar :: sidebar}"></div>

<main class="app-content">
    <p>
        <a th:href="@{/dispositivos}">← Dispositivos</a>
    </p>

    <h1>Telemetría</h1>

    <div class="card">
        <form th:action="@{/telemetria}" method="get">
            <div class="row">
                <div class="col">
                    <label for="disp">Dispositivo</label>
                    <select id="disp" name="dispositivoId" onchange="this.form.submit()">
                        <option value="">—</option> <!-- antes: th:value="" -->
                        <option th:each="d : ${dispositivos}" th:value="${d.id}"
                                th:selected="${d.id == dispositivoId}"
                                th:text="${d.nombre + ' (' + d.idExterno + ')'}">
                            Device
                        </option>
                    </select>
                </div>

                <div class="col">
                    <label for="var">Variable</label>
                    <select id="var" name="variableId">
                        <option value="">—</option> <!-- antes: th:value="" -->
                        <option th:each="v : ${variables}" th:value="${v.id}"
                                th:selected="${v.id == variableId}"
                                th:text="${v.nombre}">
                            Var
                        </option>
                    </select>
                </div>

                <div class="col">
                    <label for="limit">Cantidad</label>
                    <input id="limit" name="limit" type="number" min="1" max="500" th:value="${limit}" />
                </div>

                <div class="col" style="display:flex; align-items:flex-end;">
                    <button class="btn-primary" type="submit">Ver</button>
                </div>
            </div>
            <p class="muted">Primero elige un dispositivo; el combo de variables se llena con las variables de su plantilla.</p>
        </form>
    </div>

    <div class="card" th:if="${#lists.size(filas) > 0}">
        <h2>Últimas lecturas</h2>
        <table>
            <thead>
            <tr>
                <th>Timestamp</th>
                <th>Valor</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="f : ${filas}">
                <td th:text="${#temporals.format(f.ts, 'yyyy-MM-dd HH:mm:ss')}">—</td>
                <td>
                    <span th:if="${f.valorNumero != null}"   th:text="${f.valorNumero}"></span>
                    <span th:if="${f.valorBooleano != null}" th:text="${f.valorBooleano}"></span>
                    <span th:if="${f.valorTexto != null}"    th:text="${f.valorTexto}"></span>
                    <pre  th:if="${f.valorJson != null}"     th:text="${f.valorJson}"></pre> <!-- ahora es String -->
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <div class="card" th:if="${#lists.size(filas) == 0}">
        <p class="muted">No hay lecturas para ese filtro.</p>
    </div>
</main>
<th:block th:replace="~{components/bootstrap :: scripts-bootstrap}"></th:block>
</body>
</html>
