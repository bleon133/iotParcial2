<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Reglas - IoT Admin</title>

    <!-- Head base -->
    <th:block th:replace="~{components/bootstrap :: head-bootstrap}"></th:block>

    <!-- Estilos Glasslight -->
    <link rel="stylesheet" th:href="@{/css/base/glasslight.css}">
    <link rel="stylesheet" th:href="@{/library/bootstrap-icons/bootstrap-icons.min.css}">
    <link rel="stylesheet" th:href="@{/css/Dashboard/dashboard.css}">
</head>

<body class="glasslight">
<!-- Sidebar -->
<div th:replace="~{components/sidebar :: sidebar}"></div>

<!-- Contenido principal -->
<main class="app-content">
    <div class="container-fluid py-4">
        <header class="mb-4">
            <h1 class="fw-bold lh-1 mb-1" style="font-size:clamp(1.5rem, 3.5vw, 2.25rem);">
                Gestión de Reglas
            </h1>
            <p class="lead text-secondary mb-0">
                Crea, edita y administra las reglas de alertas basadas en variables IoT.
            </p>
        </header>

        <div class="row g-4">
            <!-- Tabla de reglas existentes -->
            <div class="col-lg-7">
                <div class="card glass-card shadow-sm">
                    <div class="card-header bg-transparent border-0">
                        <h5 class="mb-0">Listado de Reglas</h5>
                    </div>
                    <div class="card-body table-responsive">
                        <table class="table align-middle table-hover mb-0">
                            <thead class="table-light">
                            <tr>
                                <th>Nombre</th>
                                <th>Variable</th>
                                <th>Expresión</th>
                                <th>Severidad</th>
                                <th>Ventana (s)</th>
                                <th>Habilitada</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="r : ${reglas}"
                                th:attr="data-id=${r.id},data-variable=${r.variable != null ? r.variable.id : null},data-nombre=${r.nombre},data-expresion=${r.expresion},data-severidad=${r.severidad},data-habilitada=${r.habilitada},data-ventana=${r.ventanaSegundos}">
                                <td th:text="${r.nombre}"></td>
                                <td th:text="${r.variable != null && r.variable.etiqueta != null
                                  ? r.variable.etiqueta
                                  : (r.variable != null ? r.variable.nombre : '—')}">
                                </td>
                                <td th:text="${r.expresion}"></td>
                                <td th:text="${r.severidad}"></td>
                                <td th:text="${r.ventanaSegundos}"></td>
                                <td>
                                    <span th:text="${r.habilitada ? 'Sí' : 'No'}"
                                          th:classappend="${r.habilitada} ? 'text-success fw-semibold' : 'text-danger fw-semibold'"></span>
                                </td>
                                <td class="text-center">
                                    <button type="button" class="btn btn-sm btn-outline-primary me-1" onclick="editRegla(this)">
                                        <i class="bi bi-pencil"></i> Editar
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-success me-1" onclick="dupRegla(this)">
                                        <i class="bi bi-layers"></i> Duplicar
                                    </button>
                                    <form th:action="@{|/reglas/${r.id}/toggle|}" method="post" class="d-inline-block">
                                        <button class="btn btn-sm btn-outline-secondary" type="submit">
                                            <i class="bi bi-toggle-on"></i> On/Off
                                        </button>
                                    </form>
                                    <form th:action="@{|/reglas/${r.id}/eliminar|}" method="post"
                                          onsubmit="return confirm('¿Eliminar regla?');" class="d-inline-block">
                                        <button class="btn btn-sm btn-outline-danger" type="submit">
                                            <i class="bi bi-trash"></i> Eliminar
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Formulario para crear o editar -->
            <div class="col-lg-5">
                <div class="card glass-card shadow-sm">
                    <div class="card-header bg-transparent border-0">
                        <h5 class="mb-0">Nueva / Editar Regla</h5>
                    </div>
                    <div class="card-body">
                        <form method="post" action="/reglas" id="reglaForm">
                            <input type="hidden" name="id" id="reglaId" />
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Variable</label>
                                <select class="form-select" name="variableId" required>
                                    <option th:each="v : ${variables}"
                                            th:value="${v.id}"
                                            th:text="${v.etiqueta != null ? v.etiqueta : v.nombre}">
                                    </option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-semibold">Nombre</label>
                                <input class="form-control" name="nombre" required placeholder="Temperatura alta 5m"/>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-semibold">Expresión</label>
                                <input
                                        class="form-control"
                                        name="expresion"
                                        required
                                        placeholder="avg_5m > 50"
                                        pattern="(avg|min|max)(?:_\d+(?:s|m|h))?\s*(>=|<=|>|<|==|=)\s*[+-]?\d+(?:\.\d+)?"
                                />
                                <div class="form-text">
                                    Formato: <code>{avg|min|max}[_Ns|_Nm|_Nh]</code> <code>{operador}</code> <code>{número}</code><br/>
                                    Operadores permitidos: <code>&gt;</code>, <code>&lt;</code>, <code>&gt;=</code>, <code>&lt;=</code>, <code>=</code>, <code>==</code><br/>
                                    Donde:
                                    <ul class="mb-1">
                                        <li><code>_Ns</code> = ventana de N segundos</li>
                                        <li><code>_Nm</code> = ventana de N minutos</li>
                                        <li><code>_Nh</code> = ventana de N horas</li>
                                    </ul>
                                    Ejemplos válidos:
                                    <code>avg &gt; 50</code>,
                                    <code>avg_5m &gt; 50</code>,
                                    <code>min &lt; 20</code>,
                                    <code>max &gt;= 90</code>,
                                    <code>avg_30s &gt;= 10</code>,
                                    <code>max_1h &lt; 80</code>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-semibold">Severidad</label>
                                <input class="form-control" name="severidad" value="info"/>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-semibold">Ventana (segundos)</label>
                                <input class="form-control" name="ventanaSegundos" type="number" value="300" min="1"/>
                                <div class="form-text">
                                    Si la expresión incluye _5m / _30s / _1h, este valor será ignorado.
                                </div>
                            </div>

                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" name="habilitada" checked/>
                                <label class="form-check-label">Habilitada</label>
                            </div>

                            <button class="btn btn-primary w-100">
                                <i class="bi bi-save me-2"></i>Guardar
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

    </div>
</main>

<!-- Scripts base -->
<th:block th:replace="~{components/bootstrap :: scripts-bootstrap}"></th:block>

<!-- jQuery y lógica del nav -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script th:src="@{/js/nav/nav.js}" defer></script>
<script>
  function editRegla(btn){
    const tr = btn.closest('tr');
    if(!tr) return;
    const form = document.getElementById('reglaForm');
    const id = tr.getAttribute('data-id');
    const variable = tr.getAttribute('data-variable');
    const nombre = tr.getAttribute('data-nombre');
    const expresion = tr.getAttribute('data-expresion');
    const severidad = tr.getAttribute('data-severidad');
    const habilitada = tr.getAttribute('data-habilitada') === 'true';
    const ventana = tr.getAttribute('data-ventana');
    try {
      form.action = '/reglas/' + id;
      document.getElementById('reglaId').value = id;
      const selVar = form.querySelector('select[name="variableId"]');
      if(selVar) selVar.value = variable;
      const inNombre = form.querySelector('input[name="nombre"]');
      if(inNombre) inNombre.value = nombre;
      const inExpr = form.querySelector('input[name="expresion"]');
      if(inExpr) inExpr.value = expresion;
      const inSev = form.querySelector('input[name="severidad"]');
      if(inSev) inSev.value = severidad || 'info';
      const inVent = form.querySelector('input[name="ventanaSegundos"]');
      if(inVent) inVent.value = ventana || 300;
      const chk = form.querySelector('input[name="habilitada"]');
      if(chk) chk.checked = habilitada;
      form.scrollIntoView({behavior:'smooth', block:'start'});
    } catch(_){}
  }

  function dupRegla(btn){
    const tr = btn.closest('tr');
    if(!tr) return;
    const form = document.getElementById('reglaForm');
    const variable = tr.getAttribute('data-variable');
    const nombre = tr.getAttribute('data-nombre');
    const expresion = tr.getAttribute('data-expresion');
    const severidad = tr.getAttribute('data-severidad');
    const habilitada = tr.getAttribute('data-habilitada') === 'true';
    const ventana = tr.getAttribute('data-ventana');
    try {
      form.action = '/reglas';
      document.getElementById('reglaId').value = '';
      const selVar = form.querySelector('select[name="variableId"]');
      if(selVar) selVar.value = variable;
      const inNombre = form.querySelector('input[name="nombre"]');
      if(inNombre) inNombre.value = (nombre ? (nombre + ' (copia)') : '');
      const inExpr = form.querySelector('input[name="expresion"]');
      if(inExpr) inExpr.value = expresion;
      const inSev = form.querySelector('input[name="severidad"]');
      if(inSev) inSev.value = severidad || 'info';
      const inVent = form.querySelector('input[name="ventanaSegundos"]');
      if(inVent) inVent.value = ventana || 300;
      const chk = form.querySelector('input[name="habilitada"]');
      if(chk) chk.checked = habilitada;
      form.scrollIntoView({behavior:'smooth', block:'start'});
    } catch(_){}
  }
</script>
</body>
</html>
